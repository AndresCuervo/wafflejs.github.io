<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.12/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/moment.min.js"></script>
<style>
  body {
    padding: 0;
    margin: 0;
  }

  svg {
    width: 100vw;
    height: 100vh;
    font: lighter small Roboto, sans-serif;
  }

  .axis line, .axis path {
    fill: none;
    stroke: gray;
    shape-rendering: crispEdges;
  }

  path.line {
    fill: none;
    stroke: gray;
  }
</style>
<script>
  d3.csv('tickets.csv', function(row, i) {
    row['Ticket Created Date'] = moment.utc(row['Ticket Created Date'], 'YYYY-MM-DD HH:mm:ss').toDate()
    return row
  }, function(err, tickets) {
    var byEvent = _(tickets)
      .sortBy('Ticket Created Date')
      .groupBy('Event')
      .value()

    var margin = { top: 10.5, right: 50.5, bottom: 30.5, left: 40.5 }

    var svg = d3.select(document.body).append('svg')

    var chart = svg.append('g')
      .attr('class', 'chart')
      .attr('transform', `translate(${margin.left}, ${margin.top})`)

    var width = parseInt(svg.style('width')) - margin.left - margin.right,
        height = parseInt(svg.style('height')) - margin.top - margin.bottom

    // x
    _.forEach(byEvent, function(tickets, event) {
      // throw out tickets based on quantile
      var dates = _.map(tickets, 'Ticket Created Date')
      var range = [d3.quantile(dates, 0.01), d3.quantile(dates, .99)]
      _.remove(tickets, function(ticket) {
        var date = ticket['Ticket Created Date']
        return date < range[0] || range[1] < date
      })

      var first = tickets[0]['Ticket Created Date']
      tickets.x = d3.time.scale()
        .domain([first, moment(first).add(42, 'days')])
        .range([0, width])
    })
    var x = _.values(byEvent)[0].x
    var xAxis = d3.svg.axis()
      .scale(x)
      .tickFormat(function(d) { return Math.round(moment.duration(d - x.domain()[0]).asDays()) })
    chart.append('g')
      .attr('class', 'x axis')
      .attr('transform', `translate(0, ${height})`)
      .call(xAxis)

    // y
    var y = d3.scale.linear()
      .domain([0, d3.max(_(byEvent).values().map('length').value())])
      .range([height, 0])
      .nice()

    var yAxis = d3.svg.axis()
      .scale(y)
      .orient('left')
    chart.append('g')
      .attr('class', 'y axis')
      .call(yAxis)

    // line
    var color = d3.scale.category10()
      .domain(_.keys(byEvent))
    var line = d3.svg.line().interpolate('step-after')
      .x(function(ticket, i) { return byEvent[ticket.Event].x(ticket['Ticket Created Date']) })
      .y(function(ticket, i) { return y(i+1) })

    var linePaths = chart.selectAll('path.line')
      .data(_.values(byEvent))
    linePaths.enter()
      .append('path')
      .attr('class', 'line')
      .attr('stroke', function(d) { return color(d[0].Event) })
      .attr('d', line)

    // label
    chart.selectAll('text.label').data(_.values(byEvent))
      .enter()
      .append('text')
      .attr('class', 'label')
      .attr('dx', '3px')
      .attr('dy', '.35em')
      .attr('transform', function(d, i) {
        var last = d[d.length-1]
        return `translate(${d.x(last["Ticket Created Date"])}, ${y(d.length)})`
      })
      .text(function(d) {
        var month = d[0].Event.match(/WaffleJS \((.*)\)/)[1]
        return `${month} (${d.length})`
      })
  })
</script>
